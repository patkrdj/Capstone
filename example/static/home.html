<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ë¸”ë£¨ë ˆì´ ì¶”ì²œ - í™ˆ</title>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Noto Sans KR', Arial, sans-serif; margin: 0; padding: 0 16px; color: #222; }
    header, footer { padding: 16px 0; }
    header { border-bottom: 1px solid #e5e5e5; }
    footer { border-top: 1px solid #e5e5e5; margin-top: 40px; padding-top: 24px; color: #666; }
    nav a { margin-right: 12px; color: #0366d6; text-decoration: none; }
    nav a:hover { text-decoration: underline; }
    .section { margin: 24px 0; }
    .hero { border: 1px dashed #bbb; border-radius: 8px; background: #fafafa; padding: 28px; text-align: center; color: #666; }
    .grid { display: grid; gap: 12px; grid-template-columns: repeat(5, 1fr); }
    .card { border: 1px dashed #bbb; border-radius: 8px; background: #fafafa; height: 160px; display: flex; align-items: center; justify-content: center; color: #888; }
    .row { display: flex; gap: 16px; align-items: center; }
    .search-input { flex: 1; padding: 10px 12px; border: 1px solid #ddd; border-radius: 6px; }
    .button { padding: 10px 14px; border: 1px solid #ddd; background: #fff; border-radius: 6px; cursor: pointer; }
    h1, h2 { margin: 12px 0; }
  </style>
  <!-- í™ˆ í™”ë©´ ì™€ì´ì–´í”„ë ˆì„ -->
  <!-- ìƒë‹¨ ë‚´ë¹„ê²Œì´ì…˜, íˆì–´ë¡œ, ì¹´í…Œê³ ë¦¬, ì¶”ì²œ ì„¹ì…˜ -->
  <!-- ì‹¤ì œ ë°ì´í„°/ìŠ¤íƒ€ì¼ì€ ì´í›„ì— ì—°ê²° ì˜ˆì • -->
</head>
<body>
  <header>
    <nav>
      <strong>BLURAY</strong>
      <a href="/static/home.html">í™ˆ</a>
      <a href="/static/search.html">ê²€ìƒ‰</a>
      <a href="/static/login.html">ë¡œê·¸ì¸</a>
      <a href="/static/profile.html">í”„ë¡œí•„</a>
    </nav>
  </header>

  <main>
    <section class="section hero">
      <h1>ë¸”ë£¨ë ˆì´ ì¶”ì²œ</h1>
      <p>ì·¨í–¥ì— ë§ëŠ” íƒ€ì´í‹€ì„ ë°œê²¬í•´ ë³´ì„¸ìš”.</p>
      <div class="row" style="margin-top: 12px;">
        <input class="search-input" type="search" placeholder="ì œëª©, ê°ë…, ë°°ìš°ë¡œ ê²€ìƒ‰" />
        <a class="button" href="/static/search.html">ê²€ìƒ‰</a>
      </div>
    </section>

    <section class="section">
      <h2 id="recommendation-title">ê°œì¸ ì¶”ì²œ</h2>
      <div class="grid" id="recommendation-grid">
        <div class="card">ë¡œê·¸ì¸í•˜ë©´ ê°œì¸í™” ì¶”ì²œì„ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤</div>
        <div class="card">ì¶”ì²œ ë¡œë”© ì¤‘...</div>
        <div class="card">ì¶”ì²œ ë¡œë”© ì¤‘...</div>
        <div class="card">ì¶”ì²œ ë¡œë”© ì¤‘...</div>
        <div class="card">ì¶”ì²œ ë¡œë”© ì¤‘...</div>
      </div>
    </section>

    <section class="section">
      <h2 id="popular-title">ì¸ê¸° ë¸”ë£¨ë ˆì´</h2>
      <div class="grid" id="popular-grid">
        <div class="card" id = "movie-title">ë¡œë”© ì¤‘...</div>
        <div class="card">ë¡œë”© ì¤‘...</div>
        <div class="card">ë¡œë”© ì¤‘...</div>
        <div class="card">ë¡œë”© ì¤‘...</div>
        <div class="card">ë¡œë”© ì¤‘...</div>
      </div>
    </section>

    <section class="section">
      <h2>ìƒˆë¡œ ë‚˜ì˜¨ íƒ€ì´í‹€</h2>
      <div class="grid">
        <div class="card">ì¹´ë“œ</div>
        <div class="card">ì¹´ë“œ</div>
        <div class="card">ì¹´ë“œ</div>
        <div class="card">ì¹´ë“œ</div>
        <div class="card">ì¹´ë“œ</div>
      </div>
    </section>
  </main>

  <footer>
    <div>Â© 2025 Blu-ray Recommender</div>
  </footer>

  <script src="https://cdn.jsdelivr.net/npm/axios@1.4.0/dist/axios.min.js"></script>
  <script>
    async function fetchMovie() {
      try {
        const response = await axios.get('/api/movies/1');
        const movie = response.data;
        
        document.getElementById('movie-title').textContent = movie.title;
      } catch (error) {
        console.error('ì˜í™” ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨:', error);
        document.getElementById('movie-title').textContent = 'ì˜í™”ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
      }
    }

    async function fetchRecommendations() {
      try {
        const token = localStorage.getItem('accessToken');
        const recommendationGrid = document.getElementById('recommendation-grid');
        const recommendationTitle = document.getElementById('recommendation-title');
        
        if (!token) {
          recommendationTitle.textContent = 'ê°œì¸ ì¶”ì²œ (ë¡œê·¸ì¸ í•„ìš”)';
          recommendationGrid.innerHTML = '<div class="card">ë¡œê·¸ì¸í•˜ë©´ ê°œì¸í™” ì¶”ì²œì„ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤</div>';
          return;
        }
        
        recommendationTitle.textContent = 'ê°œì¸ ì¶”ì²œ ë¡œë”© ì¤‘...';
        
        const userId = Number(localStorage.getItem('userId')) || 612;
        // ì‹¤í–‰ê³¼ ë™ì‹œì— JSON ê²°ê³¼ë¥¼ ë°›ì•„ ë°”ë¡œ ì‚¬ìš© (DB ë¯¸ê²½ìœ )
        const runRes = await axios.post('/api/recommendations/run', { userId, topN: 5 }, { headers: { Authorization: `Bearer ${token}` }});
        const payload = typeof runRes.data === 'string' ? JSON.parse(runRes.data) : runRes.data;
        const list = Array.isArray(payload?.results) ? payload.results : [];
        
        recommendationTitle.textContent = 'ê°œì¸ ì¶”ì²œ';
        
        if (list.length === 0) {
          recommendationGrid.innerHTML = '<div class="card">ì¶”ì²œ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤</div>';
          return;
        }
        
        // ì¶”ì²œ ê²°ê³¼ë¥¼ ì¹´ë“œë¡œ í‘œì‹œ
        recommendationGrid.innerHTML = list.map(item => `
          <div class="card" style="cursor: pointer; text-align: center; padding: 12px;" 
               onclick="window.location.href='/static/detail.html?id=${item.saleId || item.movieId}'">
            <div style="font-weight: bold; margin-bottom: 4px;">${item.movieTitle || 'Unknown'}</div>
            <div style="font-size: 12px; color: #666;">ìœ ì‚¬ë„: ${(item.similarityScore * 100).toFixed(1)}%</div>
            ${item.reason ? `<div style="font-size: 11px; color: #888; margin-top: 4px;">${item.reason}</div>` : ''}
          </div>
        `).join('');
        
        // ì²« ë²ˆì§¸ ì¶”ì²œ ì˜í™”ë¥¼ ê¸°ì¡´ movie-titleì—ë„ í‘œì‹œ
        const firstMovie = list[0];
        if (firstMovie) {
          document.getElementById('movie-title').textContent = firstMovie.movieTitle || 'Unknown Movie';
        }
      } catch (e) {
        console.error('ì¶”ì²œ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:', e);
        document.getElementById('recommendation-title').textContent = 'ê°œì¸ ì¶”ì²œ (ì˜¤ë¥˜ ë°œìƒ)';
        document.getElementById('recommendation-grid').innerHTML = '<div class="card">ì¶”ì²œì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤</div>';
      }
    }

    async function fetchPopularMovies() {
      try {
        const popularGrid = document.getElementById('popular-grid');
        const popularTitle = document.getElementById('popular-title');
        
        popularTitle.textContent = 'ì¸ê¸° ë¸”ë£¨ë ˆì´ ë¡œë”© ì¤‘...';
        
        // ratings.csv ê¸°ë°˜ ì¸ê¸°ìˆœ ì˜í™” API í˜¸ì¶œ
        const response = await axios.get('/api/movies/popular?limit=5');
        const popularMovies = response.data;
        
        popularTitle.textContent = 'ì¸ê¸° ë¸”ë£¨ë ˆì´';
        
        if (popularMovies.length === 0) {
          popularGrid.innerHTML = '<div class="card">ì¸ê¸° ë¸”ë£¨ë ˆì´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤</div>';
          return;
        }
        
        // ì¸ê¸° ì˜í™”ë¥¼ ì¹´ë“œë¡œ í‘œì‹œ
        popularGrid.innerHTML = popularMovies.map((movie, index) => {
          const hasBluraySales = movie.salesInfo && movie.salesInfo.length > 0;
          const firstSale = hasBluraySales ? movie.salesInfo[0] : null;
          const price = firstSale ? `${firstSale.price.toLocaleString()}ì›` : 'ê°€ê²© ì •ë³´ ì—†ìŒ';
          
          return `
            <div class="card" style="cursor: pointer; text-align: center; padding: 12px; position: relative;" 
                 onclick="window.location.href='/static/detail.html?id=${movie.movieId}'">
              <div style="position: absolute; top: 8px; left: 8px; background: #0366d6; color: white; padding: 2px 6px; border-radius: 4px; font-size: 11px; font-weight: bold;">
                #${index + 1}
              </div>
              <div style="font-weight: bold; margin-bottom: 4px; margin-top: 12px; font-size: 13px; line-height: 1.3;">
                ${movie.title}
              </div>
              <div style="font-size: 11px; color: #666; margin-bottom: 2px;">
                â­ ${movie.averageRating.toFixed(1)} (${movie.ratingCount}ëª…)
              </div>
              <div style="font-size: 11px; color: #888; margin-bottom: 4px;">
                ì¸ê¸°ì ìˆ˜: ${movie.popularityScore.toFixed(1)}
              </div>
              ${hasBluraySales ? `
                <div style="font-size: 11px; color: #0366d6; font-weight: bold;">
                  ğŸ“€ ${price}
                </div>
                <div style="font-size: 10px; color: #888;">
                  ${firstSale.siteName}
                </div>
              ` : `
                <div style="font-size: 11px; color: #999;">
                  ë¸”ë£¨ë ˆì´ íŒë§¤ ì •ë³´ ì—†ìŒ
                </div>
              `}
            </div>
          `;
        }).join('');
        
        // ì²« ë²ˆì§¸ ì¸ê¸° ì˜í™”ë¥¼ ê¸°ì¡´ movie-titleì—ë„ í‘œì‹œ (í•˜ìœ„ í˜¸í™˜ì„±)
        const firstMovie = popularMovies[0];
        if (firstMovie) {
          const movieTitleElement = document.getElementById('movie-title');
          if (movieTitleElement && popularGrid.contains(movieTitleElement)) {
            movieTitleElement.textContent = firstMovie.title;
          }
        }
        
      } catch (error) {
        console.error('ì¸ê¸° ë¸”ë£¨ë ˆì´ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:', error);
        document.getElementById('popular-title').textContent = 'ì¸ê¸° ë¸”ë£¨ë ˆì´ (ì˜¤ë¥˜ ë°œìƒ)';
        document.getElementById('popular-grid').innerHTML = '<div class="card">ì¸ê¸° ë¸”ë£¨ë ˆì´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤</div>';
      }
    }

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ì˜í™”/ì¶”ì²œ/ì¸ê¸° ë¸”ë£¨ë ˆì´ ê°€ì ¸ì˜¤ê¸°
    window.addEventListener('DOMContentLoaded', () => { 
      fetchMovie(); 
      fetchRecommendations(); 
      fetchPopularMovies(); 
    });


  </script>
</body>
</html>

