<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>블루레이 추천 - 상세</title>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Noto Sans KR', Arial, sans-serif; margin: 0; padding: 0 16px; color: #222; }
    header, footer { padding: 16px 0; }
    header { border-bottom: 1px solid #e5e5e5; }
    footer { border-top: 1px solid #e5e5e5; margin-top: 40px; padding-top: 24px; color: #666; }
    nav a { margin-right: 12px; color: #0366d6; text-decoration: none; }
    nav a:hover { text-decoration: underline; }
    .section { margin: 24px 0; }
    .row { display: flex; gap: 16px; }
    .col { flex: 1; }
    .poster { width: 260px; height: 360px; border: 1px dashed #bbb; border-radius: 8px; background: #fafafa; }
    .meta { border: 1px dashed #bbb; border-radius: 8px; background: #fafafa; padding: 12px; color: #666; }
    .button { padding: 10px 14px; border: 1px solid #ddd; background: #fff; border-radius: 6px; cursor: pointer; }
    .grid { display: grid; gap: 12px; grid-template-columns: repeat(5, 1fr); }
    .card { border: 1px dashed #bbb; border-radius: 8px; background: #fafafa; height: 140px; display: flex; align-items: center; justify-content: center; color: #888; }
  </style>
  <!-- 상세 화면 와이어프레임 -->
  <!-- 포스터, 메타 정보, 설명, 스펙, 리뷰, 연관 추천 -->
</head>
<body>
  <header>
    <nav>
      <strong>BLURAY</strong>
      <a href="/static/home.html">홈</a>
      <a href="/static/search.html">검색</a>
      <a href="/static/login.html">로그인</a>
      <a href="/static/profile.html">프로필</a>
    </nav>
  </header>

  <main>
    <section class="section">
      <div class="row">
        <div class="poster" id="posterBox" style="display:flex;align-items:center;justify-content:center;color:#999;">이미지</div>
        <div class="col">
          <h1>타이틀 이름</h1>
          <div class="meta">
            <div>장르 · 감독 · 출연</div>
            <div>발매일 · 러닝타임 · 리전</div>
            <div>평점 ★★★★☆ (4.2)</div>
          </div>
          <div class="row" style="margin-top: 12px;">
            <button class="button">찜하기</button>
            <button class="button">장바구니</button>
            <button class="button">구매</button>
          </div>
        </div>
      </div>
    </section>

    <section class="section">
      <h2>설명</h2>
      <div class="meta">작품 소개 텍스트 영역</div>
    </section>

    <section class="section">
      <h2>디스크 스펙</h2>
      <div class="meta">해상도, 오디오, 자막, 부가영상 등</div>
    </section>

    <section class="section">
      <h2>판매 정보</h2>
      <div class="meta" id="salesBox">판매 정보가 없습니다.</div>
    </section>

    <section class="section">
      <h2>리뷰</h2>
      <div class="meta">
        <div style="margin-bottom:8px;">리뷰 작성</div>
        <div class="row" style="gap:8px; align-items:center;">
          <select id="ratingSelect" class="button">
            <option value="5.0">★★★★★ 5.0</option>
            <option value="4.5">★★★★☆ 4.5</option>
            <option value="4.0" selected>★★★★☆ 4.0</option>
            <option value="3.5">★★★☆☆ 3.5</option>
            <option value="3.0">★★★☆☆ 3.0</option>
            <option value="2.5">★★☆☆☆ 2.5</option>
            <option value="2.0">★★☆☆☆ 2.0</option>
            <option value="1.5">★☆☆☆☆ 1.5</option>
            <option value="1.0">★☆☆☆☆ 1.0</option>
            <option value="0.5">☆ 0.5</option>
          </select>
          <input id="commentInput" class="search-input" type="text" placeholder="한 줄 리뷰" style="flex:1;" />
          <button id="submitReview" class="button">등록</button>
        </div>
        <div id="reviewAuthHint" style="margin-top:8px; color:#666; display:none;">
          리뷰를 작성하려면 로그인이 필요합니다. <a href="/static/login.html">로그인 하러가기</a>
        </div>
        <div id="reviewListBox" style="margin-top:12px;"></div>
      </div>
    </section>

    <section class="section">
      <h2>연관 추천</h2>
      <div class="grid">
        <div class="card">카드</div>
        <div class="card">카드</div>
        <div class="card">카드</div>
        <div class="card">카드</div>
        <div class="card">카드</div>
      </div>
    </section>
  </main>

  <footer>
    <div>© 2025 Blu-ray Recommender</div>
  </footer>
  <script>
    (function() {
      function getId() {
        const params = new URLSearchParams(window.location.search);
        const q = params.get('id');
        if (q) return q;
        const parts = window.location.pathname.split('/').filter(Boolean);
        const last = parts[parts.length - 1];
        if (last && /^\d+$/.test(last)) return last;
        return '1';
      }

      function isSaleMode() {
        const params = new URLSearchParams(window.location.search);
        return (params.get('type') === 'sale');
      }

      async function fetchMovie(movieId) {
        const res = await fetch(`/api/movies/${movieId}`);
        if (!res.ok) throw new Error('failed to fetch movie');
        return await res.json();
      }

      async function fetchSaleById(saleId) {
        const res = await fetch(`/api/sales/${saleId}`);
        if (!res.ok) throw new Error('failed to fetch sale');
        return await res.json();
      }

      async function fetchReviewsBySalesId(salesId) {
        const res = await fetch(`/api/reviews?salesId=${encodeURIComponent(salesId)}`);
        if (!res.ok) throw new Error('failed to fetch reviews');
        return await res.json();
      }

      function render(movie, sales) {
        const titleEl = document.querySelector('h1');
        if (titleEl) {
          const saleTitle = (Array.isArray(sales) && sales.length > 0 && sales[0]?.blurayTitle) ? sales[0].blurayTitle : null;
          titleEl.textContent = saleTitle || movie?.title || titleEl.textContent;
        }

        const salesBox = document.getElementById('salesBox');
        if (salesBox) {
          if (!Array.isArray(sales) || sales.length === 0) {
            salesBox.textContent = '판매 정보가 없습니다.';
          } else {
            const ul = document.createElement('ul');
            ul.style.margin = '0';
            ul.style.paddingLeft = '16px';
            sales.forEach(s => {
              const li = document.createElement('li');
              const site = s.siteName ?? '-';
              const price = (s.price != null) ? s.price : '-';
              const region = (s.regionCode ? String(s.regionCode) : '-');
              const quality = s.quality ?? '-';
              const link = s.siteUrl ? ` (${s.siteUrl})` : '';
              const le = s.isLimitedEdition ? ' LE' : '';
              li.textContent = `${site}: ${price}원, 품질 ${quality}, 리전 ${region}${le}${link}`;
              ul.appendChild(li);
            });
            salesBox.innerHTML = '';
            salesBox.appendChild(ul);
          }
        }

        // 포스터 이미지 표시 (가능 시)
        const poster = document.getElementById('posterBox');
        if (poster) {
          const first = Array.isArray(sales) && sales.length > 0 ? sales[0] : null;
          const url = first?.imageLink;
          if (url) {
            poster.innerHTML = '';
            const img = document.createElement('img');
            img.src = url;
            img.alt = 'cover';
            img.style.maxWidth = '100%';
            img.style.maxHeight = '100%';
            img.loading = 'lazy';
            poster.appendChild(img);
          }
        }
      }

      (async function init() {
        const id = getId();
        try {
          if (isSaleMode()) {
            const sale = await fetchSaleById(id);
            const movie = await fetchMovie(sale.movieId);
            render(movie, [
              {
                siteName: sale.siteName,
                siteUrl: sale.siteUrl,
                price: sale.price,
                quality: sale.quality,
                regionCode: sale.regionCode,
                isLimitedEdition: sale.isLimitedEdition,
                imageLink: sale.imageLink,
                blurayTitle: sale.blurayTitle
              }
            ]);
            wireReviewForm({ saleId: id });
            await loadReviews(id);
          } else {
            // Try sale first (so /static/detail.html?id=<saleId> works), then fallback to movie
            try {
              const sale = await fetchSaleById(id);
              const movie = await fetchMovie(sale.movieId);
              render(movie, [
                {
                  siteName: sale.siteName,
                  siteUrl: sale.siteUrl,
                  price: sale.price,
                  quality: sale.quality,
                  regionCode: sale.regionCode,
                  isLimitedEdition: sale.isLimitedEdition,
                  imageLink: sale.imageLink,
                  blurayTitle: sale.blurayTitle
                }
              ]);
              wireReviewForm({ saleId: id });
              await loadReviews(id);
            } catch (_) {
              const movie = await fetchMovie(id);
              render(movie, []);
              // 영화 ID만 있는 경우, 어느 세일에 대한 리뷰인지 불분명하므로 폼 비활성화
              wireReviewForm({ disabled: true });
            }
          }
        } catch (e) {
          console.error(e);
        }
      })();

      async function loadReviews(salesId) {
        try {
          const list = await fetchReviewsBySalesId(salesId);
          renderReviews(list);
        } catch (e) {
          console.error(e);
          renderReviews([]);
        }
      }

      function renderReviews(list) {
        const box = document.getElementById('reviewListBox');
        if (!box) return;
        if (!Array.isArray(list) || list.length === 0) {
          box.innerHTML = '<div style="color:#666;">아직 등록된 리뷰가 없습니다.</div>';
          return;
        }
        const ul = document.createElement('ul');
        ul.style.margin = '8px 0 0 0';
        ul.style.paddingLeft = '16px';
        list.forEach(r => {
          const li = document.createElement('li');
          const ts = r.createdAt ? new Date(r.createdAt).toLocaleString('ko-KR') : '';
          const ratingVal = (typeof r.rating === 'number') ? r.rating : parseFloat(r.rating);
          const ratingText = isNaN(ratingVal) ? '-' : `${ratingVal.toFixed(1)}점`;
          const userLabel = r.username ? `[${r.username}] ` : (r.userId != null ? `[user:${r.userId}] ` : '');
          li.textContent = `${userLabel}${ratingText}${r.reviewComment ? ' - ' + r.reviewComment : ''}${ts ? ' (' + ts + ')' : ''}`;
          ul.appendChild(li);
        });
        box.innerHTML = '';
        box.appendChild(ul);
      }

      function wireReviewForm(ctx) {
        const btn = document.getElementById('submitReview');
        const ratingSel = document.getElementById('ratingSelect');
        const commentInput = document.getElementById('commentInput');
        const authHint = document.getElementById('reviewAuthHint');
        if (!btn) return;

        if (ctx?.disabled) {
          btn.disabled = true;
          btn.title = '세일 ID가 없어서 리뷰를 등록할 수 없습니다.';
          return;
        }

        // 로그인 상태 체크
        const token = localStorage.getItem('accessToken');
        if (!token) {
          btn.disabled = true;
          btn.title = '로그인이 필요합니다.';
          if (authHint) authHint.style.display = 'block';
          return;
        } else if (authHint) {
          authHint.style.display = 'none';
        }

        btn.addEventListener('click', async function() {
          try {
            const salesId = parseInt(ctx.saleId, 10);
            const rating = parseFloat(ratingSel.value);
            const reviewComment = commentInput.value || null;
            const token = localStorage.getItem('accessToken');
            if (!token) {
              alert('로그인이 필요합니다. 로그인 후 다시 시도하세요.');
              return;
            }
            const res = await fetch('/api/reviews', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
              body: JSON.stringify({ salesId, rating, reviewComment })
            });
            if (!res.ok) throw new Error('failed to submit review');
            alert('리뷰가 등록되었습니다.');
            commentInput.value = '';
            await loadReviews(salesId);
          } catch (e) {
            console.error(e);
            alert('리뷰 등록에 실패했습니다.');
          }
        });
      }
    })();
  </script>
</body>
</html>

